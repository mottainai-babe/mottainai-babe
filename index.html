<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>もったいないベビー｜ベビー用品ゆずりあい</title>

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      --primary:#1f8f5a;
      --primary-2:#167247;
      --primary-soft:#e8f6ef;

      --radius:18px;
      --shadow:0 8px 24px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
    }
    .wrap{max-width:1040px;margin:0 auto;padding:18px 14px 40px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .cardPad{padding:16px}
    @media (min-width:860px){ .cardPad{padding:20px} }

    .topbar{
      position:sticky;top:0;z-index:5;
      background:rgba(246,247,248,.86);
      backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(229,231,235,.7);
    }
    .topbarInner{
      max-width:1040px;margin:0 auto;
      padding:10px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:var(--primary-soft);
      border:1px solid rgba(31,143,90,.18);
      overflow:hidden;flex:0 0 auto;
      display:flex;align-items:center;justify-content:center;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .brandName{font-weight:900;line-height:1.1}
    .brandTag{font-size:12px;color:var(--muted)}

    .btn{
      border:none;cursor:pointer;
      border-radius:999px;
      padding:10px 14px;
      font-size:14px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      transition:.15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{background:var(--primary);color:#fff}
    .btnPrimary:hover{background:var(--primary-2)}
    .btnGhost{background:#f3f4f6;color:var(--text)}
    .btnGhost:hover{filter:brightness(.97)}
    .hidden{display:none}

    .intro{
      margin-top:14px;
      display:grid;gap:12px;
      text-align:center;
    }
    .introHero{
      padding:26px 18px;
      background:linear-gradient(180deg, rgba(31,143,90,.18), rgba(255,255,255,0));
      border:1px solid rgba(31,143,90,.18);
      border-radius:20px;
    }
    .introLogo{
      width:120px;height:120px;border-radius:24px;
      overflow:hidden;margin:0 auto 14px;
      border:1px solid rgba(229,231,235,.8);
      background:#fff;
    }
    .introLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .introTitle{margin:0;font-size:22px;line-height:1.25}
    .introDesc{margin:10px 0 0;color:var(--muted);line-height:1.6}
    .introBtns{margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

    .state{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(107,114,128,.35);
      background:#fff;
      text-align:left;
      white-space:pre-wrap;
    }
    .err{color:#b91c1c}

    .mainGrid{
      margin-top:14px;
      display:grid;gap:14px;
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="topbarInner">
      <a class="brand" href="./">
        <div class="logo">
          <img src="./logo.png" alt="Mottainai Babe">
        </div>
        <div>
          <div class="brandName">もったいないベビー</div>
          <div class="brandTag">ベビー用品ゆずりあい</div>
        </div>
      </a>

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <button id="loginBtn" class="btn btnPrimary">Googleでログイン</button>
        <button id="logoutBtn" class="btn btnGhost hidden">ログアウト</button>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- Intro (로그인 전) -->
    <section id="intro" class="intro">
      <div class="introHero">
        <div class="introLogo"><img src="./logo.png" alt=""></div>
        <h1 class="introTitle">“もったいない”から “ありがとう”へ</h1>
        <p class="introDesc">
          出品一覧はログインなしでも見られます。<br>
          出品・提案などの操作はログイン後に使えます。
        </p>
        <div class="introBtns">
          <button id="introLoginBtn" class="btn btnPrimary">Googleでログイン</button>
          <button id="enterBtn" class="btn btnGhost">ログインせずに見る</button>
        </div>

        <div id="debugBox" class="state">状態: 初期化中...</div>
      </div>
    </section>

    <!-- Main (로그인 후/또는 둘러보기) -->
    <section id="main" class="mainGrid hidden">
      <div class="card cardPad">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
          <h2 style="margin:0;">出品一覧</h2>
          <div style="color:var(--muted);font-size:13px;">
            ユーザー: <b id="userLabel">未ログイン</b>
          </div>
        </div>
        <div style="margin-top:12px;color:var(--muted);line-height:1.6">
          ✅ 여기부터는 원래 당신 코드(리스트/상세/업로드)를 다시 붙여 넣으면 됩니다.<br>
          지금은 로그인 문제 해결을 위해 최소 구조로 둔 상태입니다.
        </div>
      </div>

      <div class="card cardPad">
        <h3 style="margin:0 0 10px;">디버그</h3>
        <div id="debugBox2" class="state">...</div>
      </div>
    </section>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged,
      signOut,
      browserLocalPersistence,
      setPersistence
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ✅ 당신이 올린 설정값 기반 (필요하면 Firebase 콘솔 값과 1글자라도 다르면 안됨)
    const firebaseConfig = {
      apiKey: "AIzaSyAEk6aDtbuXU9K2bUnygYBqHMh75MeOlFU",
      authDomain: "mottainai-babe.firebaseapp.com",
      projectId: "mottainai-babe",
      // 아래는 Storage용. 로그인만이면 큰 영향 없지만, 나중에 업로드를 위해 둘 중 하나로 통일 권장:
      // storageBucket: "mottainai-babe.appspot.com",
      storageBucket: "mottainai-babe.firebasestorage.app",
      appId: "1:752649559489:web:1288d8adeef7280eb7a340"
    };

    const intro = document.getElementById("intro");
    const main = document.getElementById("main");
    const loginBtn = document.getElementById("loginBtn");
    const introLoginBtn = document.getElementById("introLoginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const enterBtn = document.getElementById("enterBtn");
    const userLabel = document.getElementById("userLabel");
    const debugBox = document.getElementById("debugBox");
    const debugBox2 = document.getElementById("debugBox2");

    function logDebug(msg, isError=false){
      const line = (isError ? "❌ " : "✅ ") + msg;
      debugBox.textContent = debugBox.textContent + "\n" + line;
      debugBox2.textContent = debugBox2.textContent + "\n" + line;
      if(isError){
        debugBox.classList.add("err");
      }
      console.log(line);
    }

    // init
    debugBox.textContent = `状態: Firebase初期化中...
host: ${location.host}
origin: ${location.origin}
`;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ✅ 로그인 상태 유지 (새로고침해도 유지)
    await setPersistence(auth, browserLocalPersistence).catch((e)=>{
      logDebug("setPersistence error: " + (e?.code || e?.message), true);
    });

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    async function doLogin(){
      logDebug("ログイン開始...");
      // 1) popup 먼저 시도 (Cloudflare Pages에서 가장 안정)
      try{
        const r = await signInWithPopup(auth, provider);
        logDebug("Popupログイン成功: " + (r.user?.email || ""));
        return;
      }catch(e){
        logDebug("Popup失敗: " + (e?.code || e?.message), true);

        // 팝업이 막힌 경우 redirect로 fallback
        const code = e?.code || "";
        if(code.includes("popup-blocked") || code.includes("operation-not-supported-in-this-environment")){
          logDebug("Redirectに切り替えます...");
          await signInWithRedirect(auth, provider);
          return;
        }

        alert("ログインに失敗しました: " + (e?.code || e?.message));
      }
    }

    loginBtn.onclick = doLogin;
    introLoginBtn.onclick = doLogin;

    logoutBtn.onclick = async () => {
      await signOut(auth).catch(e => logDebug("logout error: " + (e?.code || e?.message), true));
    };

    enterBtn.onclick = () => {
      intro.classList.add("hidden");
      main.classList.remove("hidden");
      logDebug("ログインせずに閲覧モード");
    };

    // ✅ redirect 결과 처리 (redirect를 썼을 경우에만 의미)
    try{
      const rr = await getRedirectResult(auth);
      if(rr && rr.user){
        logDebug("Redirectログイン成功: " + (rr.user.email || ""));
      }else{
        logDebug("RedirectResult: none (通常)");
      }
    }catch(e){
      // 여기서 에러가 뜨면 거의 설정/도메인/핸들러 문제
      logDebug("getRedirectResult error: " + (e?.code || e?.message), true);
    }

    // ✅ 로그인 상태 변화 UI 반영
    onAuthStateChanged(auth, (user) => {
      if(user){
        userLabel.textContent = user.email || user.uid;
        loginBtn.classList.add("hidden");
        introLoginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");

        intro.classList.add("hidden");
        main.classList.remove("hidden");

        logDebug("onAuthStateChanged: logged in ✅ " + (user.email || ""));
      }else{
        userLabel.textContent = "未ログイン";
        loginBtn.classList.remove("hidden");
        introLoginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");

        // intro는 유지 (유저가 enterBtn으로 들어갈 수 있음)
        logDebug("onAuthStateChanged: logged out");
      }
    });

  </script>
</body>
</html>
