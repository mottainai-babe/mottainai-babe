<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>もったいないベビー｜大阪のベビー用品ゆずりあい</title>

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;background:#fafafa;padding:24px;margin:0;}
    .card{max-width:920px;margin:auto;background:#fff;padding:24px;border-radius:16px;border:1px solid #e5e7eb;}
    h1{margin:0 0 8px;} h3{margin:18px 0 10px;}
    .muted{color:#6b7280;font-size:14px;} .small{font-size:12px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .hr{height:1px;background:#eee;margin:18px 0;}
    button{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-size:14px;}
    .primary{background:#2563eb;color:#fff;} .danger{background:#ef4444;color:#fff;} .ghost{background:#f3f4f6;color:#111827;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:14px;}
    @media (max-width:900px){.grid{grid-template-columns:1fr;}}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 6px;}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid #d1d5db;background:#fff;color:#111827;cursor:pointer;font-size:14px;}
    .tab.active{background:#2563eb;color:#fff;border-color:#2563eb;}
    input,textarea{padding:10px;border-radius:10px;border:1px solid #ddd;width:100%;box-sizing:border-box;font-size:14px;}
    textarea{min-height:70px;}
    img.thumb{width:160px;max-width:100%;border-radius:12px;margin-top:8px;display:block;border:1px solid #eee;background:#fafafa;}
    .itemCard{border-top:1px solid #eee;padding-top:14px;margin-top:14px;}
    .pill{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#f9fafb;color:#111827;margin-right:6px;}
    .pill.blue{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8;} .pill.green{background:#ecfdf5;border-color:#a7f3d0;color:#047857;} .pill.gray{background:#f3f4f6;border-color:#e5e7eb;color:#374151;}
    .hidden{display:none;}
    .offerBox{border:1px solid #eee;border-radius:14px;padding:12px;margin-top:12px;background:#fff;}
    .offerTop{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;}
    .twoBtns{display:flex;gap:10px;flex-wrap:wrap;}
    .right{text-align:right;}
    .warn{color:#dc2626;font-size:12px;margin-top:4px;}
  </style>
</head>

<body>
  <div class="card">
    <h1>もったいないベビー</h1>

    <p class="muted">大阪エリア限定｜ベビー用品のゆずりあいサービス</p>
    <p class="muted">
      使わなくなったベビー用品を、必要なご家庭へ。<br>
      「もったいない」を「ありがとう」に変えましょう。
    </p>

    <div class="row" style="margin-top:14px;">
      <button id="loginBtn" class="primary">Googleでログイン</button>
      <button id="logoutBtn" class="ghost hidden">ログアウト</button>
      <span class="muted" id="loginState">未ログイン</span>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <!-- LEFT: 出品 -->
      <div>
        <h3>出品する</h3>

        <div class="tabs" id="conditionTabs">
          <button type="button" class="tab active" data-value="新品に近い">新品に近い</button>
          <button type="button" class="tab" data-value="きれい">きれい</button>
          <button type="button" class="tab" data-value="使用感あり">使用感あり</button>
        </div>

        <p class="muted" style="margin-top:8px;">状態：<span id="conditionLabel">新品に近い</span></p>

        <input type="file" id="fileItem" accept="image/*" />
        <div class="small muted" style="margin-top:6px;">※画像は1枚だけ（自動で軽量化してアップロードします）</div>
        <div class="warn">※上限は5MB（それ以上は失敗する可能性があります）</div>
        <br>

        <input id="titleItem" placeholder="例：ベビーカー（無料）" />
        <br><br>

        <textarea id="descItem" placeholder="説明（任意）例：受け渡し希望エリア、使用期間など"></textarea>
        <br><br>

        <button id="uploadItemBtn" class="primary">出品する</button>

        <div class="small muted" style="margin-top:10px;">出品すると「交換提案」を受け取れます。</div>
      </div>

      <!-- RIGHT: Detail -->
      <div>
        <h3>選択した出品（詳細）</h3>
        <div id="detailEmpty" class="muted">下の「出品一覧」から商品を選んでください。</div>

        <div id="detailBox" class="hidden">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="pill gray" id="detailStatusPill">出品中</div>
              <div class="pill blue" id="detailOffersPill">提案 0件</div>
            </div>
            <button id="closeDetailBtn" class="ghost">閉じる</button>
          </div>

          <h3 id="detailTitle" style="margin:12px 0 6px;"></h3>
          <p class="muted">状態：<span id="detailCondition"></span></p>
          <img id="detailImage" class="thumb" alt="" />
          <p class="muted" id="detailDesc" style="margin-top:10px;"></p>

          <div class="hr"></div>

          <h3>この商品に交換提案する</h3>

          <div class="tabs" id="offerConditionTabs">
            <button type="button" class="tab active" data-value="新品に近い">新品に近い</button>
            <button type="button" class="tab" data-value="きれい">きれい</button>
            <button type="button" class="tab" data-value="使用感あり">使用感あり</button>
          </div>

          <p class="muted" style="margin-top:8px;">提案アイテムの状態：<span id="offerConditionLabel">新品に近い</span></p>

          <input type="file" id="fileOffer" accept="image/*" />
          <div class="small muted" style="margin-top:6px;">※画像は1枚だけ（自動で軽量化してアップロードします）</div>
          <div class="warn">※上限は5MB（それ以上は失敗する可能性があります）</div>
          <br>

          <input id="titleOffer" placeholder="例：ベビーゲート（きれい）" />
          <br><br>

          <textarea id="msgOffer" placeholder="ひとこと（任意）例：こちらと交換いかがですか？"></textarea>
          <br><br>

          <button id="submitOfferBtn" class="primary">交換提案を送る</button>

          <div class="hr"></div>

          <h3>交換提案一覧（公開）</h3>
          <div class="muted small">
            ※提案内容（写真/状態/タイトル/進行状況）は公開。<br>
            ※連絡先は「accepted」後に当事者のみ表示（Gmail作成画面/LINE共有を開きます）
          </div>
          <div id="offersList"></div>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <h3>出品一覧（全体）</h3>
    <div id="list"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, orderBy,
      updateDoc, deleteDoc, increment, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAEk6aDtbuXU9K2bUnygYBqHMh75MeOlFU",
      authDomain: "mottainai-babe.firebaseapp.com",
      projectId: "mottainai-babe",
      storageBucket: "mottainai-babe.firebasestorage.app",
      appId: "1:752649559489:web:1288d8adeef7280eb7a340"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginState = document.getElementById("loginState");

    const uploadItemBtn = document.getElementById("uploadItemBtn");
    const fileItem = document.getElementById("fileItem");
    const titleItem = document.getElementById("titleItem");
    const descItem = document.getElementById("descItem");
    const listEl = document.getElementById("list");

    const detailEmpty = document.getElementById("detailEmpty");
    const detailBox = document.getElementById("detailBox");
    const closeDetailBtn = document.getElementById("closeDetailBtn");
    const detailTitle = document.getElementById("detailTitle");
    const detailCondition = document.getElementById("detailCondition");
    const detailImage = document.getElementById("detailImage");
    const detailDesc = document.getElementById("detailDesc");
    const detailStatusPill = document.getElementById("detailStatusPill");
    const detailOffersPill = document.getElementById("detailOffersPill");

    const offersList = document.getElementById("offersList");
    const fileOffer = document.getElementById("fileOffer");
    const titleOffer = document.getElementById("titleOffer");
    const msgOffer = document.getElementById("msgOffer");
    const submitOfferBtn = document.getElementById("submitOfferBtn");

    let currentUser = null;
    let selectedCondition = "新品に近い";
    let selectedOfferCondition = "新品に近い";
    let selectedItemId = null;
    let selectedItemData = null;

    // ✅ 5MB 기준 (원하면 다시 바꿀 수 있음)
    const MAX_BYTES = 5 * 1024 * 1024;

    // ownerEmail private cache
    let cachedOwnerEmail = null;
    let cachedOwnerEmailItemId = null;

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function statusLabel(status){
      if(status === "done") return {text:"成立", cls:"green"};
      if(status === "dealing") return {text:"交渉中", cls:"blue"};
      return {text:"出品中", cls:"gray"};
    }

    function openGmailCompose({ to, subject, body }) {
      const url =
        "https://mail.google.com/mail/?view=cm&fs=1" +
        `&to=${encodeURIComponent(to)}` +
        `&su=${encodeURIComponent(subject)}` +
        `&body=${encodeURIComponent(body)}`;
      window.open(url, "_blank");
    }

    function openLineShare({ text }) {
      const url = `https://social-plugins.line.me/lineit/share?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank");
    }

    // ✅ 무료 브라우저 자동 리사이즈 (Canvas)
    // - maxSide: 최대 변 길이(px)
    // - quality: JPEG 품질(0~1)
    async function compressImage(file, { maxSide = 1600, quality = 0.78 } = {}){
      // SVG 등은 그대로 통과
      if(file.type === "image/svg+xml") return file;

      const bitmap = await createImageBitmap(file);
      let { width, height } = bitmap;

      const scale = Math.min(1, maxSide / Math.max(width, height));
      const w = Math.round(width * scale);
      const h = Math.round(height * scale);

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(bitmap, 0, 0, w, h);

      const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, "image/jpeg", quality);
      });

      if(!blob) return file;

      // 파일명 유지하되 확장자 jpg로
      const newName = (file.name.replace(/\.[^/.]+$/, "")) + ".jpg";
      return new File([blob], newName, { type: "image/jpeg" });
    }

    async function ensureUnderLimit(file){
      if(!file) throw new Error("no-file");

      // 1차: 그대로 OK면 그대로
      if(file.size <= MAX_BYTES) return file;

      // 2차: 압축 시도(점진적으로 품질 낮춤)
      let quality = 0.82;
      let maxSide = 1800;

      let current = file;
      for(let i=0; i<5; i++){
        current = await compressImage(current, { maxSide, quality });
        if(current.size <= MAX_BYTES) return current;

        // 더 줄이기
        quality -= 0.12;
        maxSide -= 250;
        if(quality < 0.35) quality = 0.35;
        if(maxSide < 900) maxSide = 900;
      }

      // 그래도 크면 실패
      throw new Error("too-large-after-compress");
    }

    // Tabs
    document.querySelectorAll("#conditionTabs .tab").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll("#conditionTabs .tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedCondition = btn.dataset.value;
        document.getElementById("conditionLabel").textContent = selectedCondition;
      };
    });

    document.querySelectorAll("#offerConditionTabs .tab").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll("#offerConditionTabs .tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedOfferCondition = btn.dataset.value;
        document.getElementById("offerConditionLabel").textContent = selectedOfferCondition;
      };
    });

    // Auth
    loginBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      try{
        await signInWithPopup(auth, provider);
      }catch(e){
        console.error("LOGIN_ERROR", e);
        alert("ログインに失敗しました。ポップアップブロック等をご確認ください。");
      }
    };

    logoutBtn.onclick = async () => {
      try{
        await signOut(auth);
      }catch(e){
        console.error("LOGOUT_ERROR", e);
      }
    };

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;

      if(user){
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        loginState.textContent = `ログイン中：${user.email ?? ""}`;
      }else{
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        loginState.textContent = "未ログイン";
      }

      await loadItems();
      if(selectedItemId) await openDetail(selectedItemId);
    });

    closeDetailBtn.onclick = () => {
      selectedItemId = null;
      selectedItemData = null;
      cachedOwnerEmail = null;
      cachedOwnerEmailItemId = null;
      detailBox.classList.add("hidden");
      detailEmpty.classList.remove("hidden");
    };

    async function getOwnerEmailPrivate(itemId){
      if(cachedOwnerEmailItemId === itemId && cachedOwnerEmail) return cachedOwnerEmail;
      try{
        const priv = await getDoc(doc(db, "itemsPrivate", itemId));
        if(priv.exists()){
          const email = priv.data().ownerEmail ?? "";
          cachedOwnerEmail = email;
          cachedOwnerEmailItemId = itemId;
          return email;
        }
      }catch(e){
        console.error("READ_ITEMS_PRIVATE_ERROR", e);
      }
      return "";
    }

    // Delete/Edit
    async function deleteItem(itemId){
      if(!currentUser){ alert("ログインしてください。"); return; }
      if(!confirm("本当に削除しますか？（画像も削除します）")) return;

      try{
        const snap = await getDoc(doc(db, "items", itemId));
        if(!snap.exists()){ alert("対象が見つかりません"); return; }
        const data = snap.data();
        if(data.ownerUid !== currentUser.uid){ alert("権限がありません（出品者のみ）"); return; }

        await deleteDoc(doc(db, "items", itemId));

        if(data.imagePath){
          try{ await deleteObject(ref(storage, data.imagePath)); }catch(e){ console.error("DELETE_STORAGE_WARNING", e); }
        }

        try{ await deleteDoc(doc(db, "itemsPrivate", itemId)); }catch(e){ console.error("DELETE_ITEMS_PRIVATE_WARNING", e); }

        alert("削除しました。");
        if(selectedItemId === itemId){
          selectedItemId = null; selectedItemData = null;
          cachedOwnerEmail = null; cachedOwnerEmailItemId = null;
          detailBox.classList.add("hidden"); detailEmpty.classList.remove("hidden");
        }
        await loadItems();
      }catch(e){
        console.error("DELETE_ITEM_ERROR", e);
        alert(`削除に失敗しました\ncode: ${e.code ?? "unknown"}\nmessage: ${e.message ?? ""}`);
      }
    }

    async function editItem(itemId){
      if(!currentUser){ alert("ログインしてください。"); return; }
      const snap = await getDoc(doc(db, "items", itemId));
      if(!snap.exists()){ alert("対象が見つかりません"); return; }
      const data = snap.data();
      if(data.ownerUid !== currentUser.uid){ alert("権限がありません（出品者のみ）"); return; }

      const newTitle = prompt("新しいタイトル", data.title ?? "");
      if(newTitle == null) return;
      const t = newTitle.trim();
      if(!t){ alert("タイトルは空にできません"); return; }

      const newDesc = prompt("新しい説明（空OK）", data.description ?? "");
      if(newDesc == null) return;
      const d = newDesc.trim();

      try{
        await updateDoc(doc(db, "items", itemId), { title: t, description: d });
        alert("更新しました。");
        await loadItems();
        if(selectedItemId === itemId) await openDetail(itemId);
      }catch(e){
        console.error("EDIT_ITEM_ERROR", e);
        alert(`更新に失敗しました\ncode: ${e.code ?? "unknown"}\nmessage: ${e.message ?? ""}`);
      }
    }

    // Create item (ownerEmail -> itemsPrivate)
    uploadItemBtn.onclick = async () => {
      if(!currentUser){ alert("先にログインしてください。"); return; }

      const file = fileItem.files[0];
      const titleText = titleItem.value.trim();
      const descText = descItem.value.trim();

      if(!file || !titleText){
        alert("画像とタイトルを入力してください。");
        return;
      }

      let f;
      try{
        f = await ensureUnderLimit(file);
      }catch(err){
        if(String(err?.message ?? err) === "too-large-after-compress"){
          alert("画像が大きすぎます。別の画像でお試しください（目安：スマホ撮影のままでもOK）。");
        }else{
          alert("画像処理に失敗しました。別の画像でお試しください。");
        }
        console.error("IMAGE_PROCESS_ERROR", err);
        return;
      }

      try{
        const imagePath = `items/${currentUser.uid}/${Date.now()}-${f.name}`;
        const storageRef = ref(storage, imagePath);

        // 정확히 어디서 실패하는지 분리
        await uploadBytes(storageRef, f).catch(e => { throw { step:"Storage upload", e }; });
        const url = await getDownloadURL(storageRef).catch(e => { throw { step:"Storage getDownloadURL", e }; });

        const itemRef = await addDoc(collection(db, "items"), {
          title: titleText,
          description: descText,
          image: url,
          imagePath,
          condition: selectedCondition,
          ownerUid: currentUser.uid,
          status: "active",
          offersCount: 0,
          acceptedOfferId: null,
          acceptedAt: null,
          createdAt: serverTimestamp()
        }).catch(e => { throw { step:"Firestore addDoc(items)", e }; });

        await setDoc(doc(db, "itemsPrivate", itemRef.id), {
          ownerUid: currentUser.uid,
          ownerEmail: currentUser.email ?? "",
          createdAt: serverTimestamp()
        }).catch(e => { throw { step:"Firestore setDoc(itemsPrivate)", e }; });

        alert("出品が完了しました。");
        fileItem.value = ""; titleItem.value = ""; descItem.value = "";

        await loadItems();
        await openDetail(itemRef.id);
      }catch(pack){
        const step = pack?.step ?? "unknown";
        const e = pack?.e ?? pack;
        console.error("CREATE_ITEM_ERROR", step, e);
        alert(`出品に失敗しました（${step}）\ncode: ${e.code ?? "unknown"}\nmessage: ${e.message ?? ""}`);
      }
    };

    async function loadItems(){
      listEl.innerHTML = "";

      let snap;
      try{
        snap = await getDocs(query(collection(db, "items"), orderBy("createdAt", "desc")));
      }catch(e){
        console.error("LOAD_ITEMS_FALLBACK", e);
        snap = await getDocs(collection(db, "items"));
      }

      if(snap.empty){
        listEl.innerHTML = `<p class="muted">まだ出品がありません。</p>`;
        return;
      }

      snap.forEach(docSnap => {
        const id = docSnap.id;
        const data = docSnap.data();
        const st = statusLabel(data.status);
        const offersCount = Number(data.offersCount ?? 0);
        const isOwner = currentUser && currentUser.uid === data.ownerUid;

        listEl.innerHTML += `
          <div class="itemCard">
            <div class="row" style="justify-content:space-between;">
              <div>
                <span class="pill ${st.cls}">${st.text}</span>
                <span class="pill blue">提案 ${offersCount}件</span>
              </div>
              <div class="row">
                <button class="ghost" data-open="${id}">詳細</button>
                ${isOwner ? `
                  <button class="ghost" data-edit="${id}">編集</button>
                  <button class="danger" data-delete="${id}">削除</button>
                ` : ``}
              </div>
            </div>

            <h3 style="margin:10px 0 6px;">${escapeHtml(data.title ?? "")}</h3>
            <p class="muted">状態：${escapeHtml(data.condition ?? "未設定")}</p>
            ${data.image ? `<img class="thumb" src="${data.image}" alt="">` : ""}
          </div>
        `;
      });

      document.querySelectorAll("[data-open]").forEach(btn => btn.onclick = () => openDetail(btn.dataset.open));
      document.querySelectorAll("[data-delete]").forEach(btn => btn.onclick = () => deleteItem(btn.dataset.delete));
      document.querySelectorAll("[data-edit]").forEach(btn => btn.onclick = () => editItem(btn.dataset.edit));
    }

    async function openDetail(itemId){
      selectedItemId = itemId;
      cachedOwnerEmail = null;
      cachedOwnerEmailItemId = null;

      try{
        const itemDoc = await getDoc(doc(db, "items", itemId));
        if(!itemDoc.exists()){
          alert("この出品が見つかりませんでした。");
          return;
        }

        selectedItemData = itemDoc.data();

        detailEmpty.classList.add("hidden");
        detailBox.classList.remove("hidden");

        detailTitle.textContent = selectedItemData.title ?? "";
        detailCondition.textContent = selectedItemData.condition ?? "未設定";
        detailImage.src = selectedItemData.image ?? "";
        detailDesc.textContent = selectedItemData.description ? selectedItemData.description : "（説明なし）";

        const st = statusLabel(selectedItemData.status);
        detailStatusPill.className = `pill ${st.cls}`;
        detailStatusPill.textContent = st.text;

        detailOffersPill.textContent = `提案 ${Number(selectedItemData.offersCount ?? 0)}件`;

        await loadOffers();
      }catch(e){
        console.error("OPEN_DETAIL_ERROR", e);
        alert(`詳細の取得に失敗しました\ncode: ${e.code ?? "unknown"}\nmessage: ${e.message ?? ""}`);
      }
    }

    // ===== submit offer =====
submitOfferBtn.onclick = async () => {
  if (!currentUser) {
    alert("先にログインしてください。");
    return;
  }
  if (!selectedItemId || !selectedItemData) {
    alert("出品を選択してください。");
    return;
  }
  if (selectedItemData.ownerUid && selectedItemData.ownerUid === currentUser.uid) {
    alert("自分の出品には提案できません。");
    return;
  }

  const f = fileOffer.files[0];
  const offerTitleText = titleOffer.value.trim();
  const offerMsgText = msgOffer.value.trim();

  if (!f || !offerTitleText) {
    alert("提案アイテムの画像とタイトルを入力してください。");
    return;
  }

  // ✅ 용량 제한(원하면 5MB로 완화) — 필요 없으면 삭제 가능
  const MAX = 5 * 1024 * 1024; // 5MB
  if (f.size > MAX) {
    alert("※画像サイズは5MB以下でアップロードしてください");
    return;
  }

  // ✅ ownerEmail 확보: (1) itemsPrivate에서 가져오기 시도 → (2) 공개 items의 ownerEmail fallback
  let ownerEmail = "";
  try {
    // 당신이 items/{itemId}/itemPrivate/main 구조를 쓰는 경우에만 성공함
    const privSnap = await getDoc(doc(db, "items", selectedItemId, "itemPrivate", "main"));
    if (privSnap.exists()) ownerEmail = privSnap.data().ownerEmail ?? "";
  } catch (e) {
    ownerEmail = "";
  }
  if (!ownerEmail) ownerEmail = selectedItemData.ownerEmail ?? "";

  try {
    // 1) upload offer image
    const path = `offers/${currentUser.uid}/${Date.now()}-${f.name}`;
    const storageRef = ref(storage, path);
    await uploadBytes(storageRef, f);
    const url = await getDownloadURL(storageRef);

    // 2) 공개 offer doc
    const offerRef = await addDoc(collection(db, "items", selectedItemId, "offers"), {
      proposerUid: currentUser.uid,
      offerTitle: offerTitleText,
      offerCondition: selectedOfferCondition,
      offerImage: url,
      status: "pending", // pending | accepted | rejected
      createdAt: serverTimestamp()
    });

    // 3) 비공개 offer doc (연락처/메시지)
    await setDoc(doc(db, "items", selectedItemId, "offersPrivate", offerRef.id), {
      proposerEmail: currentUser.email ?? "",
      ownerEmail: ownerEmail,                 // ✅ 추가 (상대방 To 채우기용)
      message: offerMsgText,
      createdAt: serverTimestamp()
    });

    // 4) 아이템 요약 업데이트
    await updateDoc(doc(db, "items", selectedItemId), {
      offersCount: increment(1),
      status: "dealing"
    });

    // ✅ 완료 메시지 수정
    alert("交換提案の出品が完了しました。");

    // reset UI
    fileOffer.value = "";
    titleOffer.value = "";
    msgOffer.value = "";

    // refresh
    await openDetail(selectedItemId);
    await loadItems();
  } catch (e) {
    alert("提案に失敗しました。Storage / Firestore ルールをご確認ください。");
    console.error(e);
  }
};


    async function loadOffers(){
      offersList.innerHTML = "";

      let snap;
      try{
        snap = await getDocs(query(collection(db, "items", selectedItemId, "offers"), orderBy("createdAt", "desc")));
      }catch(e){
        console.error("LOAD_OFFERS_FALLBACK", e);
        snap = await getDocs(collection(db, "items", selectedItemId, "offers"));
      }

      if(snap.empty){
        offersList.innerHTML = `<p class="muted">まだ提案がありません。</p>`;
        return;
      }

      const isOwner = !!(currentUser && selectedItemData && currentUser.uid === selectedItemData.ownerUid);

      for(const docSnap of snap.docs){
        const offerId = docSnap.id;
        const d = docSnap.data();

        const offerStatus = d.status ?? "pending";
        const statusPill =
          offerStatus === "accepted" ? `<span class="pill green">accepted</span>` :
          offerStatus === "rejected" ? `<span class="pill gray">rejected</span>` :
          `<span class="pill blue">pending</span>`;

        const isProposer = !!(currentUser && d.proposerUid === currentUser.uid);
        const canContact = (offerStatus === "accepted") && (isOwner || isProposer);

        let proposerEmail = "";
        if(canContact){
          try{
            const priv = await getDoc(doc(db, "items", selectedItemId, "offersPrivate", offerId));
            if(priv.exists()) proposerEmail = priv.data().proposerEmail ?? "";
          }catch(e){
            console.error("READ_OFFERS_PRIVATE_ERROR", e);
          }
        }

        let ownerEmail = "";
        if(canContact){
          ownerEmail = await getOwnerEmailPrivate(selectedItemId);
        }

        const baseMsg =
`【もったいないベビー】交換が成立しました
出品：${selectedItemData.title}
提案：${d.offerTitle}
状態：出品(${selectedItemData.condition}) / 提案(${d.offerCondition})

受け渡し場所・日時の希望を教えてください。`;

        const acceptBtn = (isOwner && selectedItemData.status !== "done" && offerStatus === "pending") ? `
          <button class="primary" data-accept="${offerId}">この提案を受諾</button>
        ` : "";

        const contactButtons = canContact ? `
          <div class="twoBtns" style="margin-top:10px;">
            <button class="primary" data-mail="${offerId}">メールで連絡</button>
            <button class="ghost" data-line="${offerId}">LINEで連絡</button>
          </div>
          <div class="muted small" style="margin-top:6px;">
            ※自動送信ではなく、作成画面（Gmail/LINE共有）を開きます
          </div>
        ` : "";

        offersList.innerHTML += `
          <div class="offerBox">
            <div class="offerTop">
              <div>
                ${statusPill}
                <h4 style="margin:8px 0 6px;">${escapeHtml(d.offerTitle ?? "")}</h4>
                <p class="muted">提案アイテム状態：${escapeHtml(d.offerCondition ?? "未設定")}</p>
              </div>
              <div class="right">${acceptBtn}</div>
            </div>
            ${d.offerImage ? `<img class="thumb" src="${d.offerImage}" alt="">` : ""}
            ${contactButtons}
          </div>
        `;

        setTimeout(() => {
          const acceptEl = document.querySelector(`button[data-accept="${offerId}"]`);
          if(acceptEl) acceptEl.onclick = () => acceptOffer(offerId);

          const mailEl = document.querySelector(`button[data-mail="${offerId}"]`);
          if(mailEl){
            mailEl.onclick = () => {
              const to = isOwner ? proposerEmail : ownerEmail;
              if(!to){
                alert("連絡先が取得できません（Rules設定をご確認ください）");
                return;
              }
              openGmailCompose({
                to,
                subject: `【もったいないベビー】交換成立：${selectedItemData.title}`,
                body: baseMsg
              });
            };
          }

          const lineEl = document.querySelector(`button[data-line="${offerId}"]`);
          if(lineEl){
            lineEl.onclick = () => openLineShare({ text: baseMsg });
          }
        }, 0);
      }

      detailOffersPill.textContent = `提案 ${snap.size}件`;
    }
  </script>
</body>
</html>
