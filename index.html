<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

  import {
    getFirestore,
    collection,
    doc,
    addDoc,
    setDoc,
    getDoc,
    getDocs,
    query,
    orderBy,
    updateDoc,
    deleteDoc,
    increment,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

  // ===== Firebase config =====
  const firebaseConfig = {
    apiKey: "AIzaSyAEk6aDtbuXU9K2bUnygYBqHMh75MeOlFU",
    authDomain: "mottainai-babe.firebaseapp.com",
    projectId: "mottainai-babe",
    storageBucket: "mottainai-babe.firebasestorage.app",
    appId: "1:752649559489:web:1288d8adeef7280eb7a340"
  };

  // ===== init =====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ===== elements =====
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginState = document.getElementById("loginState");

  const uploadItemBtn = document.getElementById("uploadItemBtn");
  const fileItem = document.getElementById("fileItem");
  const titleItem = document.getElementById("titleItem");
  const descItem = document.getElementById("descItem");

  const listEl = document.getElementById("list");

  const detailEmpty = document.getElementById("detailEmpty");
  const detailBox = document.getElementById("detailBox");
  const closeDetailBtn = document.getElementById("closeDetailBtn");

  const detailTitle = document.getElementById("detailTitle");
  const detailCondition = document.getElementById("detailCondition");
  const detailImage = document.getElementById("detailImage");
  const detailDesc = document.getElementById("detailDesc");
  const detailStatusPill = document.getElementById("detailStatusPill");
  const detailOffersPill = document.getElementById("detailOffersPill");

  const offersList = document.getElementById("offersList");

  const fileOffer = document.getElementById("fileOffer");
  const titleOffer = document.getElementById("titleOffer");
  const msgOffer = document.getElementById("msgOffer");
  const submitOfferBtn = document.getElementById("submitOfferBtn");

  // ===== state =====
  let currentUser = null;

  let selectedCondition = "新品に近い";
  let selectedOfferCondition = "新品に近い";

  let selectedItemId = null;
  let selectedItemData = null;

  // ===== helpers =====
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function statusLabel(status){
    if(status === "done") return {text:"成立", cls:"green"};
    if(status === "dealing") return {text:"交渉中", cls:"blue"};
    return {text:"出品中", cls:"gray"};
  }

  function openGmailCompose({ to, subject, body }) {
    const url =
      "https://mail.google.com/mail/?view=cm&fs=1" +
      `&to=${encodeURIComponent(to)}` +
      `&su=${encodeURIComponent(subject)}` +
      `&body=${encodeURIComponent(body)}`;
    window.open(url, "_blank");
  }

  function openLineShare({ text }) {
    const url = `https://social-plugins.line.me/lineit/share?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank");
  }

  // ===== login / logout =====
  loginBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    try{
      await signInWithPopup(auth, provider);
    }catch(e){
      alert("ログインに失敗しました。ポップアップブロック等をご確認ください。");
      console.error(e);
    }
  };

  logoutBtn.onclick = async () => {
    await signOut(auth);
  };

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;

    if(user){
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      loginState.textContent = `ログイン中：${user.email ?? ""}`;
    }else{
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      loginState.textContent = "未ログイン";
    }

    await loadItems();
    if(selectedItemId){
      await openDetail(selectedItemId);
    }
  });

  closeDetailBtn.onclick = () => {
    selectedItemId = null;
    selectedItemData = null;
    detailBox.classList.add("hidden");
    detailEmpty.classList.remove("hidden");
  };

  // ===== tabs (item condition) =====
  document.querySelectorAll("#conditionTabs .tab").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll("#conditionTabs .tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedCondition = btn.dataset.value;
      document.getElementById("conditionLabel").textContent = selectedCondition;
    };
  });

  // ===== tabs (offer condition) =====
  document.querySelectorAll("#offerConditionTabs .tab").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll("#offerConditionTabs .tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedOfferCondition = btn.dataset.value;
      document.getElementById("offerConditionLabel").textContent = selectedOfferCondition;
    };
  });

  // ===== delete / edit =====
  async function deleteItem(itemId){
    if(!currentUser){
      alert("ログインしてください。");
      return;
    }
    if(!confirm("本当に削除しますか？（提案は残る可能性があります）")){
      return;
    }

    try{
      await deleteDoc(doc(db, "items", itemId));
      alert("削除しました。");

      if(selectedItemId === itemId){
        selectedItemId = null;
        selectedItemData = null;
        detailBox.classList.add("hidden");
        detailEmpty.classList.remove("hidden");
      }
      await loadItems();
    }catch(e){
      alert(`削除に失敗しました\n\n${e.code ?? ""}\n${e.message ?? ""}`);
      console.error(e);
    }
  }

  async function editItemTitle(itemId, currentTitle){
    if(!currentUser){
      alert("ログインしてください。");
      return;
    }

    const newTitle = prompt("新しいタイトルを入力してください", currentTitle ?? "");
    if(newTitle == null) return; // cancel
    const trimmed = newTitle.trim();
    if(!trimmed){
      alert("タイトルは空にできません");
      return;
    }

    try{
      await updateDoc(doc(db, "items", itemId), { title: trimmed });
      alert("更新しました。");
      await loadItems();
      if(selectedItemId === itemId){
        await openDetail(itemId);
      }
    }catch(e){
      alert(`更新に失敗しました\n\n${e.code ?? ""}\n${e.message ?? ""}`);
      console.error(e);
    }
  }

  // ===== create item =====
  uploadItemBtn.onclick = async () => {
    if(!currentUser){
      alert("先にログインしてください。");
      return;
    }

    const f = fileItem.files[0];
    const titleText = titleItem.value.trim();
    const descText = descItem.value.trim();

    if(!f || !titleText){
      alert("画像とタイトルを入力してください。");
      return;
    }

    // 2MB check (f 존재 확인 후!)
    const MAX = 2 * 1024 * 1024;
    if(f.size > MAX){
      alert("※画像サイズは2MB以下でアップロードしてください");
      return;
    }

    try{
      const path = `items/${currentUser.uid}/${Date.now()}-${f.name}`;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, f);
      const url = await getDownloadURL(storageRef);

      const itemRef = await addDoc(collection(db, "items"), {
        title: titleText,
        description: descText,
        image: url,
        condition: selectedCondition,
        ownerUid: currentUser.uid,
        ownerEmail: currentUser.email ?? "",
        status: "active",
        offersCount: 0,
        acceptedOfferId: null,
        acceptedAt: null,
        createdAt: serverTimestamp()
      });

      alert("出品完了しました。");
      fileItem.value = "";
      titleItem.value = "";
      descItem.value = "";

      await loadItems();
      await openDetail(itemRef.id);
    }catch(e){
      console.error("UPLOAD ERROR:", e);
      alert(`出品に失敗しました\n\ncode:\n${e.code ?? "unknown"}\n\nmessage:\n${e.message ?? ""}`);
    }
  };

  // ===== load items list =====
  async function loadItems(){
    listEl.innerHTML = "";

    let snap;
    try{
      const q = query(collection(db, "items"), orderBy("createdAt", "desc"));
      snap = await getDocs(q);
    }catch{
      snap = await getDocs(collection(db, "items"));
    }

    if(snap.empty){
      listEl.innerHTML = `<p class="muted">まだ出品がありません。</p>`;
      return;
    }

    snap.forEach(docSnap => {
      const id = docSnap.id;
      const data = docSnap.data();

      const st = statusLabel(data.status);
      const offersCount = Number(data.offersCount ?? 0);
      const isOwner = currentUser && currentUser.uid === data.ownerUid;

      listEl.innerHTML += `
        <div class="itemCard">
          <div class="row" style="justify-content:space-between;">
            <div>
              <span class="pill ${st.cls}">${st.text}</span>
              <span class="pill blue">提案 ${offersCount}件</span>
            </div>

            <div class="row">
              <button class="ghost" data-open="${id}">詳細</button>
              ${isOwner ? `
                <button class="ghost" data-edit="${id}">編集</button>
                <button class="danger" data-delete="${id}">削除</button>
              ` : ``}
            </div>
          </div>

          <h3 style="margin:10px 0 6px;">${escapeHtml(data.title ?? "")}</h3>
          <p class="muted">状態：${escapeHtml(data.condition ?? "未設定")}</p>
          ${data.image ? `<img class="thumb" src="${data.image}" alt="">` : ""}
        </div>
      `;
    });

    // wire buttons
    document.querySelectorAll("[data-open]").forEach(btn=>{
      btn.onclick = () => openDetail(btn.dataset.open);
    });

    document.querySelectorAll("[data-delete]").forEach(btn=>{
      btn.onclick = () => deleteItem(btn.dataset.delete);
    });

    document.querySelectorAll("[data-edit]").forEach(btn=>{
      const id = btn.dataset.edit;
      // 현재 title 가져오기: 같은 카드의 h3를 읽어서 기본값으로 넣음
      const card = btn.closest(".itemCard");
      const currentTitle = card?.querySelector("h3")?.textContent ?? "";
      btn.onclick = () => editItemTitle(id, currentTitle);
    });
  }

  // ===== open detail =====
  async function openDetail(itemId){
    selectedItemId = itemId;

    const itemDoc = await getDoc(doc(db, "items", itemId));
    if(!itemDoc.exists()){
      alert("この出品が見つかりませんでした。");
      return;
    }

    selectedItemData = itemDoc.data();

    detailEmpty.classList.add("hidden");
    detailBox.classList.remove("hidden");

    detailTitle.textContent = selectedItemData.title ?? "";
    detailCondition.textContent = selectedItemData.condition ?? "未設定";
    detailImage.src = selectedItemData.image ?? "";
    detailDesc.textContent = selectedItemData.description ? selectedItemData.description : "（説明なし）";

    const st = statusLabel(selectedItemData.status);
    detailStatusPill.className = `pill ${st.cls}`;
    detailStatusPill.textContent = st.text;

    detailOffersPill.textContent = `提案 ${Number(selectedItemData.offersCount ?? 0)}件`;

    await loadOffers();
  }

  // ===== submit offer =====
  submitOfferBtn.onclick = async () => {
    if(!currentUser){
      alert("先にログインしてください。");
      return;
    }
    if(!selectedItemId){
      alert("出品を選択してください。");
      return;
    }
    if(selectedItemData?.ownerUid && selectedItemData.ownerUid === currentUser.uid){
      alert("自分の出品には提案できません。");
      return;
    }

    const f = fileOffer.files[0];
    const offerTitleText = titleOffer.value.trim();
    const offerMsgText = msgOffer.value.trim();

    if(!f || !offerTitleText){
      alert("提案アイテムの画像とタイトルを入力してください。");
      return;
    }

    // offer 2MB check
    const MAX = 2 * 1024 * 1024;
    if(f.size > MAX){
      alert("※画像サイズは2MB以下でアップロードしてください");
      return;
    }

    try{
      const path = `offers/${currentUser.uid}/${Date.now()}-${f.name}`;
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, f);
      const url = await getDownloadURL(storageRef);

      const offerRef = await addDoc(collection(db, "items", selectedItemId, "offers"), {
        proposerUid: currentUser.uid,
        offerTitle: offerTitleText,
        offerCondition: selectedOfferCondition,
        offerImage: url,
        status: "pending",
        createdAt: serverTimestamp()
      });

      await setDoc(doc(db, "items", selectedItemId, "offersPrivate", offerRef.id), {
        proposerEmail: currentUser.email ?? "",
        message: offerMsgText,
        createdAt: serverTimestamp()
      });

      await updateDoc(doc(db, "items", selectedItemId), {
        offersCount: increment(1),
        status: "dealing"
      });

      alert("交換提案を送信しました。");

      fileOffer.value = "";
      titleOffer.value = "";
      msgOffer.value = "";

      await openDetail(selectedItemId);
      await loadItems();
    }catch(e){
      alert(`提案に失敗しました\n\n${e.code ?? ""}\n${e.message ?? ""}`);
      console.error(e);
    }
  };

  // ===== accept offer (owner only) =====
  async function acceptOffer(offerId){
    if(!currentUser || !selectedItemData) return;
    if(selectedItemData.ownerUid !== currentUser.uid){
      alert("出品者のみ操作できます。");
      return;
    }

    try{
      await updateDoc(doc(db, "items", selectedItemId, "offers", offerId), { status: "accepted" });
      await updateDoc(doc(db, "items", selectedItemId), {
        status: "done",
        acceptedOfferId: offerId,
        acceptedAt: serverTimestamp()
      });

      alert("この提案を受諾しました。連絡ボタンが表示されます。");
      await openDetail(selectedItemId);
      await loadItems();
    }catch(e){
      alert(`受諾に失敗しました\n\n${e.code ?? ""}\n${e.message ?? ""}`);
      console.error(e);
    }
  }

  // ===== load offers list =====
  async function loadOffers(){
    offersList.innerHTML = "";

    let snap;
    try{
      const q = query(collection(db, "items", selectedItemId, "offers"), orderBy("createdAt", "desc"));
      snap = await getDocs(q);
    }catch{
      snap = await getDocs(collection(db, "items", selectedItemId, "offers"));
    }

    if(snap.empty){
      offersList.innerHTML = `<p class="muted">まだ提案がありません。</p>`;
      return;
    }

    const isOwner = !!(currentUser && selectedItemData && currentUser.uid === selectedItemData.ownerUid);

    for(const docSnap of snap.docs){
      const offerId = docSnap.id;
      const d = docSnap.data();

      const offerStatus = d.status ?? "pending";
      const statusPill =
        offerStatus === "accepted" ? `<span class="pill green">accepted</span>` :
        offerStatus === "rejected" ? `<span class="pill gray">rejected</span>` :
        `<span class="pill blue">pending</span>`;

      const isProposer = !!(currentUser && d.proposerUid === currentUser.uid);
      const canContact = (offerStatus === "accepted") && (isOwner || isProposer);

      let privateData = null;
      if(canContact){
        try{
          const priv = await getDoc(doc(db, "items", selectedItemId, "offersPrivate", offerId));
          if(priv.exists()) privateData = priv.data();
        }catch{
          privateData = null;
        }
      }

      const ownerEmail = selectedItemData.ownerEmail ?? "";
      const proposerEmail = privateData?.proposerEmail ?? "";

      const baseMsg =
`【もったいないベビー】交換が成立しました
出品：${selectedItemData.title}
提案：${d.offerTitle}
状態：出品(${selectedItemData.condition}) / 提案(${d.offerCondition})

受け渡し場所・日時の希望を教えてください。`;

      const contactButtons = canContact ? `
        <div class="twoBtns" style="margin-top:10px;">
          <button class="primary" data-mail="${offerId}">メールで連絡</button>
          <button class="ghost" data-line="${offerId}">LINEで連絡</button>
        </div>
        <div class="muted small" style="margin-top:6px;">
          ※自動送信ではなく、作成画面（Gmail/LINE共有）を開きます
        </div>
      ` : "";

      const acceptBtn = (isOwner && selectedItemData.status !== "done" && offerStatus === "pending") ? `
        <button class="primary" data-accept="${offerId}">この提案を受諾</button>
      ` : "";

      offersList.innerHTML += `
        <div class="offerBox">
          <div class="offerTop">
            <div>
              ${statusPill}
              <h4 style="margin:8px 0 6px;">${escapeHtml(d.offerTitle ?? "")}</h4>
              <p class="muted">提案アイテム状態：${escapeHtml(d.offerCondition ?? "未設定")}</p>
            </div>
            <div class="right">
              ${acceptBtn}
            </div>
          </div>
          ${d.offerImage ? `<img class="thumb" src="${d.offerImage}" alt="">` : ""}
          ${contactButtons}
        </div>
      `;

      setTimeout(() => {
        const acceptEl = document.querySelector(`button[data-accept="${offerId}"]`);
        if(acceptEl) acceptEl.onclick = () => acceptOffer(offerId);

        const mailEl = document.querySelector(`button[data-mail="${offerId}"]`);
        if(mailEl){
          mailEl.onclick = () => {
            const to = isOwner ? proposerEmail : ownerEmail;
            if(!to){
              alert("連絡先が取得できませんでした（ルール設定をご確認ください）。");
              return;
            }
            openGmailCompose({
              to,
              subject: `【もったいないベビー】交換成立：${selectedItemData.title}`,
              body: baseMsg
            });
          };
        }

        const lineEl = document.querySelector(`button[data-line="${offerId}"]`);
        if(lineEl){
          lineEl.onclick = () => openLineShare({ text: baseMsg });
        }
      }, 0);
    }

    detailOffersPill.textContent = `提案 ${snap.size}件`;
  }
</script>
